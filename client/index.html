<!-- –¢–≤–æ—è —Ä–∞–∑–º–µ—Ç–∫–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π -->
<script>
  const socket = new WebSocket("wss://messenger-server-l789.onrender.com");
  let isRegistered = false;
  let currentUser = "";

  const statusEl = document.getElementById("status");

  socket.addEventListener("open", () => {
    statusEl.textContent = "üü¢ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ";
  });

  socket.addEventListener("message", async (event) => {
    let parsed;

    try {
      parsed = JSON.parse(event.data);
    } catch {
      return;
    }

    if (parsed.type === 'history') {
      parsed.messages.forEach(msg => {
        const li = document.createElement("li");
        li.textContent = `${msg.username}: ${msg.message}`;
        document.getElementById("chat").appendChild(li);
      });
    }

    if (parsed.type === 'message') {
      const li = document.createElement("li");
      li.textContent = parsed.text;
      document.getElementById("chat").appendChild(li);
    }

    if (parsed.type === 'online-users') {
      document.getElementById("userList").textContent =
        parsed.users.length ? parsed.users.join(", ") : "–Ω–∏–∫–æ–≥–æ :(";
    }
  });

  function register() {
    const username = document.getElementById("username").value.trim();
    if (!username) return alert("–í–≤–µ–¥–∏—Ç–µ –∏–º—è");

    currentUser = username;
    socket.send(JSON.stringify({ type: "register", from: username }));
    isRegistered = true;
    statusEl.textContent = `üü¢ –í—ã –≤–æ—à–ª–∏ –∫–∞–∫ "${username}"`;
  }

  function sendMessage() {
    const to = document.getElementById("recipient").value.trim();
    const msg = document.getElementById("msgInput").value.trim();

    if (!isRegistered) return alert("–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å");
    if (!to || !msg) return alert("–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏ —Å–æ–æ–±—â–µ–Ω–∏–µ");

    socket.send(JSON.stringify({
      type: "message",
      from: currentUser,
      to,
      message: msg
    }));

    const li = document.createElement("li");
    li.textContent = `–í—ã ‚Üí ${to}: ${msg}`;
    li.classList.add("self");
    document.getElementById("chat").appendChild(li);

    document.getElementById("msgInput").value = "";
  }
</script>
